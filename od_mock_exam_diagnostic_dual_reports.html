<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OD on the GO — Mock Boards Exam (Diagnostic)</title>
<style>
  :root{ --bg:#ffffff; --fg:#111; --muted:#667085; --brand:#0b6bcb; --ok:#0a7f2e; --bad:#b00020; --card:#f8fafc; --border:#e6e8eb; }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;z-index:10}
  header .wrap{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  h1{font-size:20px;margin:0}
  .wrap small{color:var(--muted)}
  main{max-width:1100px;margin:18px auto;padding:0 16px 40px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--card);font-size:12px;color:var(--muted)}
  .question{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0}
  .qhead{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .question h3{margin:0 0 8px 0;font-size:16px}
  .choices{display:grid;gap:8px;margin-top:8px}
  label.choice{display:flex;gap:8px;align-items:flex-start;padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
  .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin:18px 0}
  button{border:1px solid var(--border);background:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
  button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  .report{margin-top:24px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
  th{background:#f6f8fb}
  .ok{color:var(--ok);font-weight:600}
  .bad{color:var(--bad);font-weight:600}
  .muted{color:var(--muted)}
  .hide{display:none}
  .rationale{margin-top:8px;font-size:13px;color:#333;border-left:3px solid var(--border);padding-left:10px}
  .summary{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:14px 0}
  .brand{font-weight:700}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
  footer{color:var(--muted);font-size:12px;margin-top:40px}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Monaco,monospace}
  input[type="text"],input[type="email"],select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
  label.inline{display:flex;gap:8px;align-items:center}
  @media print{
    header,.actions,.pill,.rationale,.meta,#studentBox{display:none!important}
    body{background:#fff}
    .question{page-break-inside:avoid}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>OD on the GO — Mock Boards Exam</h1>
    <small class="pill">NBEO®-style diagnostic report</small>
    <div style="flex:1"></div>
    <small class="muted">Form Demo • v1.2 (School Required)</small>
  </div>
</header>

<main>
  <div id="studentBox" class="summary">
    <div class="grid">
      <div>
        <label>Student name<input id="s_name" type="text" placeholder="First Last"></label>
      </div>
      <div>
        <label>School (required)
          <select id="s_school" required>
<option value="Alabama — UAB School of Optometry">Alabama — UAB School of Optometry</option>
<option value="Arizona — Midwestern University AZCOPT">Arizona — Midwestern University AZCOPT</option>
<option value="California — SCCO at Marshall B. Ketchum University">California — SCCO at Marshall B. Ketchum University</option>
<option value="California — UC Berkeley School of Optometry">California — UC Berkeley School of Optometry</option>
<option value="California — WesternU College of Optometry">California — WesternU College of Optometry</option>
<option value="Canada — University of Waterloo (School of Optometry & Vision Science)">Canada — University of Waterloo (School of Optometry & Vision Science)</option>
<option value="Canada — Université de Montréal (École d’optométrie)">Canada — Université de Montréal (École d’optométrie)</option>
<option value="Florida — Nova Southeastern University (NSU)">Florida — Nova Southeastern University (NSU)</option>
<option value="Illinois — Illinois College of Optometry (ICO)">Illinois — Illinois College of Optometry (ICO)</option>
<option value="Indiana — IU School of Optometry">Indiana — IU School of Optometry</option>
<option value="Kentucky — KYCO (University of Pikeville)">Kentucky — KYCO (University of Pikeville)</option>
<option value="Massachusetts — New England College of Optometry (NECO)">Massachusetts — New England College of Optometry (NECO)</option>
<option value="Michigan — Michigan College of Optometry (Ferris State)">Michigan — Michigan College of Optometry (Ferris State)</option>
<option value="Missouri — UMSL College of Optometry">Missouri — UMSL College of Optometry</option>
<option value="New York — SUNY College of Optometry">New York — SUNY College of Optometry</option>
<option value="North Carolina — High Point University School of Optometry">North Carolina — High Point University School of Optometry</option>
<option value="Ohio — The Ohio State University College of Optometry">Ohio — The Ohio State University College of Optometry</option>
<option value="Oklahoma — NSU Oklahoma College of Optometry (NSUOCO)">Oklahoma — NSU Oklahoma College of Optometry (NSUOCO)</option>
<option value="Oregon — Pacific University College of Optometry">Oregon — Pacific University College of Optometry</option>
<option value="Pennsylvania — Salus University (PCO)">Pennsylvania — Salus University (PCO)</option>
<option value="Puerto Rico — Inter American University School of Optometry (IAUPR)">Puerto Rico — Inter American University School of Optometry (IAUPR)</option>
<option value="Texas — UIW Rosenberg School of Optometry (UIWRSO)">Texas — UIW Rosenberg School of Optometry (UIWRSO)</option>
<option value="Texas — University of Houston College of Optometry (UHCO)">Texas — University of Houston College of Optometry (UHCO)</option>
<option value="Texas — University of Texas Rio Grande Valley School of Optometry (UTRGV)">Texas — University of Texas Rio Grande Valley School of Optometry (UTRGV)</option>
<option value="Utah — Rocky Mountain University College of Optometry">Utah — Rocky Mountain University College of Optometry</option>
</select>
        </label>
      </div>
    </div>
    <small class="muted">You must select a school before you can grade the exam.</small>
  </div>

  <div class="summary">
    <div class="grid">
      <div><span class="brand">Instructions:</span> Select one answer for each question. Click <b>Grade Exam</b> to view your diagnostic report.</div>
      <div><span class="brand">Report:</span> Shows % correct by condition area (17 buckets) + overall score. Export CSV or print as PDF.</div>
    </div>
  </div>

  <div id="exam"></div>

  <div class="actions">
    <button class="primary" id="gradeBtn" disabled>Grade Exam</button>
    <button id="resetBtn">Reset</button>
    <button id="csvBtn" disabled>Export CSV</button>
    <button id="printBtn" disabled>Print / Save PDF</button>
  </div>

  <section id="report" class="report hide">
    <div class="summary">
      <div class="grid">
        <div><b>Student:</b> <span id="studentName">Anonymous</span></div>
        <div><b>School:</b> <span id="schoolName">—</span></div>
        <div><b>Date:</b> <span id="dateStamp"></span></div>
        <div><b>Total Score:</b> <span id="totalScore" class="brand"></span></div>
      </div>
    </div>

    <div class="actions" style="margin:10px 0 0 0; gap:6px;"><button id="tabBasic" class="primary">Condition-Based</button><button id="tabAdvanced">Discipline-Based</button></div><h3 id="basicTitle">Diagnostic Report by Content Area / Condition</h3>
    <table id="diagTable">
      <thead><tr><th>#</th><th>Condition Area</th><th>% Correct</th><th>Correct / Total</th></tr></thead>
      <tbody></tbody>
    </table>

    <div id="advanced" class="hide" style="margin-top:18px;"><h3>Discipline-Based Summary</h3><table id="discTable"><thead><tr><th>#</th><th>Discipline</th><th>% Correct</th><th>Correct / Total</th></tr></thead><tbody></tbody></table><div class="summary" style="margin-top:10px;"><div class="muted">Refractive/Sensory/Oculomotor includes conditions 1–8 above. Normal Health/Disease/Trauma includes conditions 9–17.</div></div></div>

    <div class="summary">
      <div><b>Legend:</b> <span class="ok">≥90% strong</span> · 75–89% steady · <span class="bad">≤74% needs review</span></div>
    </div>

    <footer>
      <div>© OD on the GO — Diagnostic generated by in-browser scoring. For educational use only.</div>
    </footer>
  </section>
</main>

<script>
const CONDITIONS = [
  "Ametropia","Ophthalmic Optics / Spectacles","Contact Lenses","Low Vision",
  "Accommodation / Vergence / Oculomotor","Amblyopia / Strabismus",
  "Perceptual Function / Color Vision","Visual & Human Development",
  "Lids / Lashes / Lacrimal / Adnexa / Orbit","Conjunctiva / Cornea / Refractive Surgery",
  "Lens / Cataract / IOL / Pre- & Post-Op Care","Episclera / Sclera / Anterior Uvea",
  "Vitreous / Retina / Choroid","Optic Nerve / Neuro-Ophthalmic Pathways",
  "Glaucoma","Emergencies / Trauma","Systemic Health"
];

const QUESTIONS = [
  {"text":"Which refractive state best describes a patient whose far point is at -50 cm from the principal plane?","choices":["*Myopia of 2.00 D","Hyperopia of 2.00 D","Emmetropia","Mixed astigmatism"],"condition":"Ametropia","rationale":"Vergence = -1/0.50 m = -2.00 D → myopia (negative power)."},
  {"text":"Which spectacle lens design reduces magnification while keeping the same vertex power?","choices":["*Plano front with increased back surface power","Steeper front curve with same back surface","Increase center thickness","Use higher index and keep curves identical"],"condition":"Ophthalmic Optics / Spectacles","rationale":"Spectacle magnification decreases with flatter front curve and thinner lens for same back vertex power."},
  {"text":"Protein deposition on soft contact lenses is most increased in which material?","choices":["*Ionic high-water hydrogel","Non-ionic low-water hydrogel","Silicone hydrogel class V","PMMA"],"condition":"Contact Lenses","rationale":"Ionic, high-water hydrogels attract positively charged tear proteins → more deposition."},
  {"text":"A +2.50 D add is prescribed. If the patient accommodates 1.00 D through the add at 40 cm, what is the effective working vergence at the eye?","choices":["*-1.50 D","-2.50 D","-2.00 D","-1.00 D"],"condition":"Accommodation / Vergence / Oculomotor","rationale":"Demand at 40 cm is -2.50 D. With +2.50 add and 1.00 D accommodation, net at eye = -1.50 D."},
  {"text":"Which finding supports congenital esotropia (infantile esotropia)?","choices":["*Large constant ET with dissociated vertical deviation","High AC/A ratio with intermittent ET at near","V-pattern exotropia","Comitant 6∆ ET with fusion"],"condition":"Amblyopia / Strabismus","rationale":"Infantile ET: large constant ET, DVD, latent nystagmus; presents in first 6 months."},
  {"text":"Which test best isolates red-green congenital deficiency?","choices":["*Ishihara pseudoisochromatic plates","Farnsworth D-15 desaturated","Anomaloscope luminance match only","Nagel equation with tritan confusion"],"condition":"Perceptual Function / Color Vision","rationale":"Ishihara plates screen for protan/deutan (RG) congenital defects effectively."},
  {"text":"A painful red eye with ciliary flush, photophobia, and small irregular pupil most likely indicates:","choices":["*Anterior uveitis","Bacterial conjunctivitis","Episcleritis","Acute angle closure"],"condition":"Episclera / Sclera / Anterior Uvea","rationale":"Anterior uveitis: pain, photophobia, cells/flare, miosis/irregular pupil; ciliary flush common."},
  {"text":"Which optic neuropathy typically presents with altitudinal field loss and crowded discs?","choices":["*Non-arteritic anterior ischemic optic neuropathy (NAION)","Leber hereditary optic neuropathy","Toxic-nutritional optic neuropathy","Compressive chiasmopathy"],"condition":"Optic Nerve / Neuro-Ophthalmic Pathways","rationale":"NAION: sudden painless vision loss, altitudinal defect, small 'disc-at-risk' fellow eye."},
  {"text":"A RAPD with shallow anterior chamber peripherally, mid-dilated pupil, and corneal edema suggests:","choices":["*Acute primary angle-closure glaucoma","Open-angle glaucoma","Episcleritis","Herpetic keratitis"],"condition":"Glaucoma","rationale":"Acute angle-closure: corneal edema, mid-dilated fixed pupil, severe pain, high IOP."},
  {"text":"In diabetic ketoacidosis, which acid–base disturbance is expected?","choices":["*Metabolic acidosis with respiratory compensation","Respiratory acidosis","Metabolic alkalosis with respiratory compensation","Mixed respiratory alkalosis/metabolic alkalosis"],"condition":"Systemic Health","rationale":"DKA produces metabolic acidosis (ketone bodies); Kussmaul respirations provide respiratory compensation."}
];

const examDiv = document.getElementById('exam');
const gradeBtn = document.getElementById('gradeBtn');
const schoolSelect = document.getElementById('s_school');

function renderExam(){
  examDiv.innerHTML = '';
  QUESTIONS.forEach((q, i) => {
    const qWrap = document.createElement('div');
    qWrap.className = 'question';
    const header = `<div class="qhead"><h3>${i+1}. ${q.text}</h3><div class="meta"><span class="pill">${q.condition}</span></div></div>`;
    const choices = q.choices.map((c, idx) => {
      const id = `q${i}_c${idx}`;
      return `<label class="choice"><input type="radio" name="q${i}" id="${id}" value="${c.replace('*','')}" />${c.replace('*','')}</label>`;
    }).join('');
    qWrap.innerHTML = header + `<div class="choices">${choices}</div><div class="rationale hide" id="rat${i}"></div>`;
    examDiv.appendChild(qWrap);
  });
}
renderExam();

function getCorrectIndex(choices){ return choices.findIndex(c => c.trim().startsWith('*')); }

function scoreExam(){
  const perCondition = {}; CONDITIONS.forEach(c => perCondition[c] = {correct:0,total:0});
  let correctTotal = 0;
  QUESTIONS.forEach((q,i) =>{
    const radios = document.querySelectorAll(`input[name="q${i}"]`);
    let chosen = null; radios.forEach(r => { if(r.checked) chosen = r.value; });
    const correctChoice = q.choices[getCorrectIndex(q.choices)].replace('*','');
    const isCorrect = (chosen === correctChoice);
    if(isCorrect) correctTotal++;
    perCondition[q.condition].total += 1;
    if(isCorrect) perCondition[q.condition].correct += 1;
    const rat = document.getElementById('rat'+i);
    rat.classList.remove('hide');
    const icon = isCorrect ? '✅' : '❌';
    rat.innerHTML = `${icon} <b>Correct:</b> ${correctChoice}<br>${q.rationale}`;
  });
  const pct = Math.round((correctTotal / QUESTIONS.length)*100);
  return {perCondition, correctTotal, total: QUESTIONS.length, pct};
}

const reportEl = document.getElementById('report');
const diagTbody = document.querySelector('#diagTable tbody');
const totalScoreEl = document.getElementById('totalScore');
const dateStampEl = document.getElementById('dateStamp');

function renderReport(result){
  reportEl.classList.remove('hide');
  diagTbody.innerHTML='';
  let idx=1;
  for(const cond of CONDITIONS){
    const rec = result.perCondition[cond];
    if(rec.total===0) continue;
    const pct = Math.round((rec.correct/rec.total)*100);
    const cls = pct>=90?'ok':(pct>=75?'':'bad');
    diagTbody.insertAdjacentHTML('beforeend', `<tr><td>${idx++}</td><td>${cond}</td><td class="${cls}">${pct}%</td><td>${rec.correct} / ${rec.total}</td></tr>`);
  }
  totalScoreEl.textContent = `${result.pct}% (${result.correctTotal} / ${result.total})`;
  dateStampEl.textContent = new Date().toLocaleString();
  document.getElementById('studentName').textContent = document.getElementById('s_name').value || 'Anonymous';
  document.getElementById('schoolName').textContent = schoolSelect.value || '—';
  document.getElementById('csvBtn').disabled = false;
  document.getElementById('printBtn').disabled = false;
}

document.getElementById('csvBtn').addEventListener('click', () => {
  const lines = [['Condition Area','Correct','Total','Percent']];
  CONDITIONS.forEach(cond => {
    const row = Array.from(diagTbody.querySelectorAll('tr')).find(tr => tr.children[1]?.textContent===cond);
    if(row){
      lines.push([cond, row.children[3].textContent.split(' / ')[0], row.children[3].textContent.split(' / ')[1], row.children[2].textContent]);
    }
  });
  const overall = document.getElementById('totalScore').textContent;
  lines.push([]);
  lines.push(['Overall', overall]);
  const csv = lines.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'OD_on_the_GO_Diagnostic.csv';
  a.click();
});

gradeBtn.addEventListener('click', () => {
  if(!schoolSelect.value){ alert('Please select your school before grading.'); return; }
  const res = scoreExam(); renderReport(res); window.scrollTo({top: reportEl.offsetTop-20, behavior:'smooth'});
});

document.getElementById('resetBtn').addEventListener('click', () => {
  renderExam(); reportEl.classList.add('hide');
  document.getElementById('csvBtn').disabled = true; document.getElementById('printBtn').disabled = true;
  window.scrollTo({top:0, behavior:'smooth'});
});

// enable Grade button when a school is selected
schoolSelect.addEventListener('change', () => { gradeBtn.disabled = !schoolSelect.value; });

// ==== Tabs (Condition vs Discipline) ====
const tabBasic = document.getElementById('tabBasic');
const tabAdvanced = document.getElementById('tabAdvanced');
const advancedBox = document.getElementById('advanced');
const basicTitle = document.getElementById('basicTitle');

function showBasic(){
  tabBasic.classList.add('primary'); tabAdvanced.classList.remove('primary');
  document.getElementById('diagTable').parentElement.classList.remove('hide');
  advancedBox.classList.add('hide');
  basicTitle.classList.remove('hide');
}
function showAdvanced(){
  tabAdvanced.classList.add('primary'); tabBasic.classList.remove('primary');
  document.getElementById('diagTable').parentElement.classList.add('hide');
  advancedBox.classList.remove('hide');
  basicTitle.classList.add('hide');
}
if(tabBasic && tabAdvanced){
  tabBasic.addEventListener('click', showBasic);
  tabAdvanced.addEventListener('click', showAdvanced);
}

// ==== Discipline aggregation ====
// Discipline 1: Refractive Status / Sensory Processes / Oculomotor (conditions index 0..7)
// Discipline 2: Normal Health / Disease / Trauma (conditions index 8..16)
function buildDisciplineTable(result){
  const discTbody = document.querySelector('#discTable tbody');
  if(!discTbody) return;
  const d1 = {correct:0,total:0};
  const d2 = {correct:0,total:0};
  CONDITIONS.forEach((cond, idx) => {
    const rec = result.perCondition[cond];
    if(!rec) return;
    if(idx <= 7){ d1.correct += rec.correct; d1.total += rec.total; }
    else { d2.correct += rec.correct; d2.total += rec.total; }
  });
  const rows = [];
  const pct1 = d1.total? Math.round(100*d1.correct/d1.total):0;
  const pct2 = d2.total? Math.round(100*d2.correct/d2.total):0;
  const cls1 = pct1>=90?'ok':(pct1>=75?'':'bad');
  const cls2 = pct2>=90?'ok':(pct2>=75?'':'bad');
  rows.push(`<tr><td>1</td><td>Refractive Status / Sensory Processes / Oculomotor</td><td class="${cls1}">${pct1}%</td><td>${d1.correct} / ${d1.total}</td></tr>`);
  rows.push(`<tr><td>2</td><td>Normal Health / Disease / Trauma</td><td class="${cls2}">${pct2}%</td><td>${d2.correct} / ${d2.total}</td></tr>`);
  discTbody.innerHTML = rows.join('');
}

// Hook into renderReport to also build discipline table
const _renderReportPrev = renderReport;
renderReport = function(result){
  _renderReportPrev(result);
  buildDisciplineTable(result);
  // default to Condition-Based view each time
  if(tabBasic && tabAdvanced){ showBasic(); }
};
</script>
</body>
</html>
