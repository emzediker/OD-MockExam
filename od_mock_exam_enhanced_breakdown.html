<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OD on the GO — Diagnostic (NBEO-weighted, Categorized)</title>
<style>
  :root{ --bg:#fff; --fg:#111; --muted:#667085; --brand:#0b6bcb; --ok:#0a7f2e; --bad:#b00020; --card:#f8fafc; --border:#e6e8eb; }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;z-index:10}
  header .wrap{max-width:1100px;margin:0 auto;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{font-size:20px;margin:0}
  .pill{border:1px solid var(--border);border-radius:999px;padding:2px 8px;background:var(--card);font-size:12px;color:var(--muted)}
  main{max-width:1100px;margin:18px auto;padding:0 16px 40px}
  .question{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0}
  .qhead{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .choices{display:grid;gap:8px;margin-top:8px}
  label.choice{display:flex;gap:8px;align-items:flex-start;padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
  .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
  .summary{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:14px 0}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin:18px 0}
  button{border:1px solid var(--border);background:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
  button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
  th{background:#f6f8fb}
  table{width:100%;border-collapse:collapse;margin-bottom:8px}
  .ok{color:var(--ok);font-weight:600}
  .bad{color:var(--bad);font-weight:600}
  .muted{color:var(--muted)}
  .hide{display:none}
  .brand{font-weight:700}
  .rationale{margin-top:8px;font-size:13px;border-left:3px solid var(--border);padding-left:10px}
  input[type="text"],select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
  @media print{header,.actions,.rationale,.meta,#studentBox,.question{display:none!important} body{background:#fff}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>OD on the GO — Diagnostic</h1>
    <span class="pill">NBEO-weighted • Discipline → Condition → Subcategory</span>
    <div style="flex:1"></div>
    <small class="muted">Student-facing</small>
  </div>
</header>

<main>
  <div id="studentBox" class="summary">
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;">
      <label>Student name
        <input id="s_name" type="text" placeholder="First Last">
      </label>
      <label>School (required)
        <select id="s_school" required>
          <option value="" selected>Select your school…</option>
          <option value="Alabama — UAB School of Optometry">Alabama — UAB School of Optometry</option>
          <option value="Arizona — Midwestern University AZCOPT">Arizona — Midwestern University AZCOPT</option>
          <option value="California — SCCO at Marshall B. Ketchum University">California — SCCO at Marshall B. Ketchum University</option>
          <option value="California — UC Berkeley School of Optometry">California — UC Berkeley School of Optometry</option>
          <option value="California — WesternU College of Optometry">California — WesternU College of Optometry</option>
          <option value="Canada — University of Waterloo (School of Optometry & Vision Science)">Canada — University of Waterloo (School of Optometry & Vision Science)</option>
          <option value="Canada — Université de Montréal (École d’optométrie)">Canada — Université de Montréal (École d’optométrie)</option>
          <option value="Florida — Nova Southeastern University (NSU)">Florida — Nova Southeastern University (NSU)</option>
          <option value="Illinois — Illinois College of Optometry (ICO)">Illinois — Illinois College of Optometry (ICO)</option>
          <option value="Indiana — IU School of Optometry">Indiana — IU School of Optometry</option>
          <option value="Kentucky — KYCO (University of Pikeville)">Kentucky — KYCO (University of Pikeville)</option>
          <option value="Massachusetts — New England College of Optometry (NECO)">Massachusetts — New England College of Optometry (NECO)</option>
          <option value="Michigan — Michigan College of Optometry (Ferris State)">Michigan — Michigan College of Optometry (Ferris State)</option>
          <option value="Missouri — UMSL College of Optometry">Missouri — UMSL College of Optometry</option>
          <option value="New York — SUNY College of Optometry">New York — SUNY College of Optometry</option>
          <option value="North Carolina — High Point University School of Optometry">North Carolina — High Point University School of Optometry</option>
          <option value="Ohio — The Ohio State University College of Optometry">Ohio — The Ohio State University College of Optometry</option>
          <option value="Oklahoma — NSU Oklahoma College of Optometry (NSUOCO)">Oklahoma — NSUOCO</option>
          <option value="Oregon — Pacific University College of Optometry">Oregon — Pacific University College of Optometry</option>
          <option value="Pennsylvania — Salus University (PCO)">Pennsylvania — Salus University (PCO)</option>
          <option value="Puerto Rico — Inter American University School of Optometry (IAUPR)">Puerto Rico — IAUPR</option>
          <option value="Texas — UIW Rosenberg School of Optometry (UIWRSO)">Texas — UIWRSO</option>
          <option value="Texas — University of Houston College of Optometry (UHCO)">Texas — UHCO</option>
          <option value="Texas — University of Texas Rio Grande Valley School of Optometry (UTRGV)">Texas — UTRGV</option>
          <option value="Utah — Rocky Mountain University College of Optometry">Utah — Rocky Mountain University</option>
        </select>
      </label>
    </div>
    <small class="muted">You must select a school before grading.</small>
  </div>

  <div class="summary">
    <div><span class="brand">Instructions:</span> One answer per question. Click <b>Grade Exam</b> to see and print your score report.</div>
  </div>

  <div id="exam"></div>

  <div class="actions">
    <button id="gradeBtn" class="primary" disabled>Grade Exam</button>
    <button id="resetBtn">Reset</button>
    <button id="printBtn" disabled>Print / Download PDF</button>
  </div>

  <section id="report" class="hide">
    <div class="summary">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
        <div><b>Student:</b> <span id="studentName">Anonymous</span></div>
        <div><b>School:</b> <span id="schoolName">—</span></div>
        <div><b>Date:</b> <span id="dateStamp"></span></div>
        <div><b>Total Score:</b> <span id="totalScore" class="brand"></span></div>
        <div><b>Status:</b> <span id="submitStatus" class="muted">Local only</span></div>
      </div>
    </div>

    <h3>Discipline-Level Summary</h3>
    <table id="discSummary"><thead><tr><th>#</th><th>Discipline</th><th>% Correct</th><th>Correct / Total</th></tr></thead><tbody></tbody></table>

    <h3>Condition Breakdown</h3>
    <table id="condTable"><thead><tr><th>#</th><th>Condition Area</th><th>% Correct</th><th>Correct / Total</th></tr></thead><tbody></tbody></table>

    <h3>Subcategory Breakdown</h3>
    <div id="subcats"></div>

    <div class="summary">
      <div><b>Legend:</b> <span class="ok">≥90% strong</span> · 75–89% steady · <span class="bad">≤74% needs review</span></div>
    </div>
  </section>
</main>

<script>
/* ====== CONFIG ====== */
const QUESTIONS_URL = "./questions.json";

/* Taxonomy lists (for reporting order) */
const DISCIPLINES = [
  "A. Anatomy","B. Biochemistry / Physiology","C. Immunology / Microbiology / Pathology","D. Optics","E. Pharmacology"
];
const CONDITIONS = [
  "Ametropia","Ophthalmic Optics / Spectacles","Contact Lenses","Low Vision",
  "Accommodation / Vergence / Oculomotor","Amblyopia / Strabismus","Perceptual Function / Color Vision","Visual & Human Development",
  "Lids / Lashes / Lacrimal / Adnexa / Orbit","Conjunctiva / Cornea / Refractive Surgery","Lens / Cataract / IOL / Pre- & Post-Op Care",
  "Episclera / Sclera / Anterior Uvea","Vitreous / Retina / Choroid","Optic Nerve / Neuro-Ophthalmic Pathways","Glaucoma","Emergencies / Trauma","Systemic Health"
];

/* ====== UTIL ====== */
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function pctClass(p){ return p>=90?'ok':(p>=75?'':'bad'); }

/* ====== RENDER ====== */
const examDiv = document.getElementById('exam');
const reportEl = document.getElementById('report');
const dateEl = document.getElementById('dateStamp');
const totalEl = document.getElementById('totalScore');
const discBody = document.querySelector('#discSummary tbody');
const condBody = document.querySelector('#condTable tbody');
const subHost = document.getElementById('subcats');

let QUESTIONS = []; // loaded from JSON
let SHUFFLED = [];  // copy of QUESTIONS with choice shuffles

function renderExam(){
  examDiv.innerHTML = '';
  SHUFFLED.forEach((q,i)=>{
    const wrap = document.createElement('div'); wrap.className='question';
    const meta = `
      <div class="meta">
        <span class="pill">${q.discipline}</span>
        <span class="pill">${q.condition}</span>
        <span class="pill">${q.sub}</span>
      </div>`;
    const choicesHtml = q.choices.map((c,idx)=>
      `<label class="choice"><input type="radio" name="q${i}" value="${idx}" />${c}</label>`).join('');
    wrap.innerHTML = `
      <div class="qhead"><h3>${i+1}. ${q.text}</h3>${meta}</div>
      <div class="choices">${choicesHtml}</div>
      <div id="rat${i}" class="rationale hide"></div>`;
    examDiv.appendChild(wrap);
  });
}

function scoreExam(){
  const perCond = {}; CONDITIONS.forEach(c=>perCond[c]={correct:0,total:0});
  const perDisc = {}; DISCIPLINES.forEach(d=>perDisc[d]={correct:0,total:0});
  const perSub  = {}; CONDITIONS.forEach(c=>perSub[c]={});

  let correctTotal=0;
  const answers=[];

  SHUFFLED.forEach((q,i)=>{
    const picked = document.querySelector(`input[name='q${i}']:checked`);
    const chosenIdx = picked ? parseInt(picked.value,10) : -1;
    const ok = (chosenIdx === q.correctIndexAfterShuffle);
    if(ok) correctTotal++;

    perCond[q.condition].total++; if(ok) perCond[q.condition].correct++;
    perDisc[q.discipline].total++; if(ok) perDisc[q.discipline].correct++;

    if(!perSub[q.condition][q.sub]) perSub[q.condition][q.sub]={correct:0,total:0};
    perSub[q.condition][q.sub].total++; if(ok) perSub[q.condition][q.sub].correct++;

    const rat = document.getElementById('rat'+i);
    rat.classList.remove('hide');
    rat.innerHTML = (ok?'✅':'❌') + " <b>Correct:</b> " + q.choices[q.correctIndexAfterShuffle] +
                    (q.rationale ? ("<br>"+q.rationale) : "");
    answers.push({
      index: i+1,
      sourceId: q.id ?? null,
      discipline: q.discipline, condition: q.condition, sub: q.sub,
      chosenText: chosenIdx>=0 ? q.choices[chosenIdx] : "",
      correctText: q.choices[q.correctIndexAfterShuffle],
      isCorrect: ok
    });
  });

  const pct = Math.round(100*correctTotal/SHUFFLED.length);
  return {perCond, perDisc, perSub, answers, correctTotal, total: SHUFFLED.length, pct};
}

function pctCell(pct){ return `<td class="${pctClass(pct)}">${pct}%</td>`; }

function renderReport(res){
  reportEl.classList.remove('hide');
  dateEl.textContent = new Date().toLocaleString();
  totalEl.textContent = `${res.pct}% (${res.correctTotal} / ${res.total})`;
  document.getElementById('studentName').textContent = document.getElementById('s_name').value || 'Anonymous';
  document.getElementById('schoolName').textContent = document.getElementById('s_school').value || '—';

  // Disciplines
  let rows=[]; let idx=1;
  DISCIPLINES.forEach(d=>{
    const rec = res.perDisc[d]; if(!rec.total) return;
    const pct = Math.round(100*rec.correct/rec.total);
    rows.push(`<tr><td>${idx++}</td><td>${d}</td>${pctCell(pct)}<td>${rec.correct} / ${rec.total}</td></tr>`);
  });
  discBody.innerHTML = rows.join('');

  // Conditions
  rows=[]; idx=1;
  CONDITIONS.forEach(c=>{
    const rec = res.perCond[c]; if(!rec.total) return;
    const pct = Math.round(100*rec.correct/rec.total);
    rows.push(`<tr><td>${idx++}</td><td>${c}</td>${pctCell(pct)}<td>${rec.correct} / ${rec.total}</td></tr>`);
  });
  condBody.innerHTML = rows.join('');

  // Subcategories
  let html=''; let cidx=1;
  CONDITIONS.forEach(c=>{
    const subs = res.perSub[c]; const keys = Object.keys(subs||{});
    if(!keys.length) return;
    html += `<div class="summary" style="margin:10px 0 6px 0"><div class="brand">${cidx}. ${c}</div></div>`;
    html += '<table><thead><tr><th style="width:55%">Subcategory</th><th style="width:20%">% Correct</th><th>Correct / Total</th></tr></thead><tbody>';
    keys.sort().forEach(s=>{
      const rec = subs[s]; const pct = Math.round(100*rec.correct/rec.total);
      html += `<tr><td>${s}</td>${pctCell(pct)}<td>${rec.correct} / ${rec.total}</td></tr>`;
    });
    html += '</tbody></table>'; cidx++;
  });
  subHost.innerHTML = html || '<div class="muted">No subcategory data.</div>';

  document.getElementById('printBtn').disabled = false;
}

/* ====== PRINT / PDF (opens clean report window) ====== */
function openReportPrintWindow(){
  const report = document.getElementById('report');
  if (report.classList.contains('hide')) {
    alert('Grade the exam first, then try printing.');
    return;
  }
  const win = window.open('', '_blank', 'noopener,noreferrer');
  const styles = `
    <style>
      :root{ --fg:#111; --muted:#667085; --border:#e6e8eb; --ok:#0a7f2e; --bad:#b00020; }
      *{box-sizing:border-box} html,body{margin:0;padding:0;color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45}
      h1,h2,h3{margin:0 0 10px}
      .summary{border:1px solid var(--border);border-radius:12px;padding:12px;margin:14px 0}
      table{width:100%;border-collapse:collapse;margin-bottom:8px}
      th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
      th{background:#f6f8fb}
      .ok{color:var(--ok);font-weight:600}
      .bad{color:var(--bad);font-weight:600}
      .muted{color:var(--muted)}
      @page { size: letter; margin: 18mm; }
      @media print {
        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        a { text-decoration: none; color: inherit; }
      }
    </style>`;
  const header = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div>
        <h2 style="margin:0">OD on the GO — Diagnostic Score Report</h2>
        <div class="muted" style="font-size:12px">NBEO-weighted • Discipline → Condition → Subcategory</div>
      </div>
      <div style="text-align:right;font-size:12px;color:#667085;">
        Generated: ${new Date().toLocaleString()}
      </div>
    </div>`;
  const content = `
    <!doctype html>
    <html><head><meta charset="utf-8"><title>Score Report</title>${styles}</head>
    <body>
      <main>${header}${report.innerHTML}</main>
      <script>
        (function(){
          const fire = () => { window.focus(); window.print(); };
          if (document.fonts && document.fonts.ready) {
            document.fonts.ready.then(fire).catch(fire);
          } else {
            setTimeout(fire, 250);
          }
        })();
      <\/script>
    </body></html>`;
  win.document.open(); win.document.write(content); win.document.close();
}

/* ====== EVENTS ====== */
let _lastResult = null;

document.getElementById('gradeBtn').addEventListener('click', ()=>{
  const schoolSel = document.getElementById('s_school');
  if (!schoolSel.value) { alert('Please select your school to continue.'); schoolSel.focus(); return; }
  const res = scoreExam();
  _lastResult = res;
  renderReport(res);
  window.scrollTo({top: document.getElementById('report').offsetTop-20, behavior:'smooth'});
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  prepareShuffled(); renderExam();
  document.getElementById('report').classList.add('hide');
  document.getElementById('printBtn').disabled=true;
  const s = document.getElementById('submitStatus');
  if (s){ s.textContent='Local only'; s.className='muted'; }
  window.scrollTo({top:0,behavior:'smooth'});
});

document.getElementById('printBtn').addEventListener('click', openReportPrintWindow);

(function initSchoolGate(){
  const schoolSel = document.getElementById('s_school');
  const gradeBtn  = document.getElementById('gradeBtn');
  gradeBtn.disabled = !schoolSel.value;
  schoolSel.addEventListener('change', e => { gradeBtn.disabled = !e.target.value; });
})();

/* ====== QUESTION LOADING, NORMALIZATION & SHUFFLING ====== */
async function loadQuestions(){
  const r = await fetch(QUESTIONS_URL, {cache:'no-store'});
  if(!r.ok){ throw new Error('Failed to load questions.json'); }
  const bank = await r.json();

  // Normalize: ensure id, text, choices[], correct(index), discipline/condition/sub, rationale
  bank.forEach((q,i)=>{
    if (typeof q.id !== 'number') q.id = i+1;
    if (!Array.isArray(q.choices)) q.choices = [];
    // Allow "correct" as index OR as exact answer text; convert to index
    if (typeof q.correct === 'string') {
      const idx = q.choices.indexOf(q.correct);
      q.correct = idx >= 0 ? idx : 0; // fallback to 0 if mismatch
    } else if (typeof q.correct !== 'number') {
      q.correct = 0;
    }
  });

  QUESTIONS = bank;
}

function prepareShuffled(){
  const qs = QUESTIONS.map(q => JSON.parse(JSON.stringify(q)));
  shuffle(qs);

  qs.forEach(q=>{
    const originalChoices = q.choices.map((c,i)=>({text:c, idx:i}));
    shuffle(originalChoices);
    q.choices = originalChoices.map(o=>o.text);
    // IMPORTANT: correct index AFTER shuffle is the POSITION of the old-correct in the shuffled array
    const pos = originalChoices.findIndex(o => o.idx === q.correct);
    q.correctIndexAfterShuffle = (pos >= 0 ? pos : 0);
  });

  SHUFFLED = qs;
}

(async function boot(){
  try{
    await loadQuestions();
    prepareShuffled();
    renderExam();
  }catch(e){
    examDiv.innerHTML = `<div class="summary"><b>Error loading questions.</b> ${e.message}</div>`;
    console.error(e);
  }
})();
</script>
</body>
</html>
