<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OD on the GO — Diagnostic (NBEO-weighted, Categorized)</title>
<style>
  :root{ --bg:#fff; --fg:#111; --muted:#667085; --brand:#0b6bcb; --ok:#0a7f2e; --bad:#b00020; --card:#f8fafc; --border:#e6e8eb; }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;z-index:10}
  header .wrap{max-width:1100px;margin:0 auto;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{font-size:20px;margin:0}
  .pill{border:1px solid var(--border);border-radius:999px;padding:2px 8px;background:var(--card);font-size:12px;color:var(--muted)}
  main{max-width:1100px;margin:18px auto;padding:0 16px 40px}
  .question{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0}
  .qhead{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .choices{display:grid;gap:8px;margin-top:8px}
  label.choice{display:flex;gap:8px;align-items:flex-start;padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
  .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
  .summary{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:14px 0}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin:18px 0}
  button{border:1px solid var(--border);background:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
  button.primary{background:#0b6bcb;border-color:#0b6bcb;color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
  th{background:#f6f8fb}
  table{width:100%;border-collapse:collapse;margin-bottom:8px}
  .ok{color:#0a7f2e;font-weight:600}
  .bad{color:#b00020;font-weight:600}
  .muted{color:#667085}
  .hide{display:none}
  .brand{font-weight:700}
  .rationale{margin-top:8px;font-size:13px;border-left:3px solid var(--border);padding-left:10px}
  input[type="text"],select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
  /* Print only the report */
  @media print{
    header,.actions,#studentBox,#exam,.question,.rationale,.meta{display:none!important}
    #report{display:block!important;border:none!important}
    body{background:#fff}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>OD on the GO — Diagnostic</h1>
    <span class="pill">NBEO-weighted • Discipline → Condition → Subcategory</span>
    <div style="flex:1"></div>
    <small class="muted">Student-facing</small>
  </div>
</header>

<main>
  <div id="studentBox" class="summary">
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;">
      <label>Student name
        <input id="s_name" type="text" placeholder="First Last">
      </label>
      <label>School (optional)
        <select id="s_school">
          <option value="" selected>— Select your school (optional) —</option>
          <option>Alabama — UAB School of Optometry</option>
          <option>Arizona — Midwestern University AZCOPT</option>
          <option>California — SCCO at Marshall B. Ketchum University</option>
          <option>California — UC Berkeley School of Optometry</option>
          <option>California — WesternU College of Optometry</option>
          <option>Canada — University of Waterloo</option>
          <option>Canada — Université de Montréal</option>
          <option>Florida — Nova Southeastern University</option>
          <option>Illinois — Illinois College of Optometry</option>
          <option>Indiana — IU School of Optometry</option>
          <option>Kentucky — KYCO</option>
          <option>Massachusetts — NECO</option>
          <option>Michigan — MCO</option>
          <option>Missouri — UMSL</option>
          <option>New York — SUNY</option>
          <option>North Carolina — High Point University</option>
          <option>Ohio — OSU</option>
          <option>Oklahoma — NSUOCO</option>
          <option>Oregon — Pacific University</option>
          <option>Pennsylvania — PCO</option>
          <option>Puerto Rico — IAUPR</option>
          <option>Texas — UIWRSO</option>
          <option>Texas — UHCO</option>
          <option>Texas — UTRGV</option>
          <option>Utah — Rocky Mountain University</option>
        </select>
      </label>
    </div>
    <small class="muted">Grading will work even if the School field is left blank.</small>
  </div>

  <div class="summary">
    <div><span class="brand">Instructions:</span> One answer per question. Click <b>Grade Exam</b> to see and print your score report.</div>
  </div>

  <div id="exam"></div>

  <div class="actions">
    <button id="gradeBtn" class="primary">Grade Exam</button>
    <button id="resetBtn">Reset</button>
    <button id="printBtn" disabled>Print / Download PDF</button>
  </div>

  <section id="report" class="hide">
    <div class="summary">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
        <div><b>Student:</b> <span id="studentName">Anonymous</span></div>
        <div><b>School:</b> <span id="schoolName">—</span></div>
        <div><b>Date:</b> <span id="dateStamp"></span></div>
        <div><b>Total Score:</b> <span id="totalScore" class="brand"></span></div>
        <div><b>Status:</b> <span id="submitStatus" class="muted">Local only</span></div>
      </div>
    </div>

    <h3>Discipline-Level Summary</h3>
    <table id="discSummary"><thead><tr><th>#</th><th>Discipline</th><th>% Correct</th><th>Correct / Total</th></tr></thead><tbody></tbody></table>

    <h3>Condition Breakdown</h3>
    <table id="condTable"><thead><tr><th>#</th><th>Condition Area</th><th>% Correct</th><th>Correct / Total</th></tr></thead><tbody></tbody></table>

    <h3>Subcategory Breakdown</h3>
    <div id="subcats"></div>

    <div class="summary">
      <div><b>Legend:</b> <span class="ok">≥90% strong</span> · 75–89% steady · <span class="bad">≤74% needs review</span></div>
    </div>
  </section>
</main>

<script>
/* ---------------- CONFIG ---------------- */
const QUESTIONS_URL = "./questions.json";

/* canonical names WITHOUT A/B/C/D/E prefixes */
const DISCIPLINES = [
  "Anatomy","Biochemistry / Physiology","Immunology / Microbiology / Pathology","Optics","Pharmacology"
];

const CONDITIONS = [
  "Ametropia","Ophthalmic Optics / Spectacles","Contact Lenses","Low Vision",
  "Accommodation / Vergence / Oculomotor","Amblyopia / Strabismus","Perceptual Function / Color Vision","Visual & Human Development",
  "Lids / Lashes / Lacrimal / Adnexa / Orbit","Conjunctiva / Cornea / Refractive Surgery","Lens / Cataract / IOL / Pre- & Post-Op Care",
  "Episclera / Sclera / Anterior Uvea","Vitreous / Retina / Choroid","Optic Nerve / Neuro-Ophthalmic Pathways","Glaucoma","Emergencies / Trauma","Systemic Health"
];

/* ---------------- NORMALIZATION HELPERS ---------------- */
const CANON_DISC = {
  "Anatomy":"Anatomy",
  "Biochemistry / Physiology":"Biochemistry / Physiology",
  "Immunology / Microbiology / Pathology":"Immunology / Microbiology / Pathology",
  "Optics":"Optics",
  "Pharmacology":"Pharmacology"
};

const CANON_COND = Object.fromEntries(CONDITIONS.map(c=>[c,c]));

const DISC_ALIASES = {
  "a anatomy":"Anatomy","anatomy":"Anatomy",
  "b biochemistry / physiology":"Biochemistry / Physiology","biochemistry / physiology":"Biochemistry / Physiology",
  "c immunology / microbiology / pathology":"Immunology / Microbiology / Pathology","immunology / microbiology / pathology":"Immunology / Microbiology / Pathology",
  "d optics":"Optics","optics":"Optics",
  "e pharmacology":"Pharmacology","pharmacology":"Pharmacology"
};

const COND_ALIASES = {
  "ophthalmic optics/spectacles":"Ophthalmic Optics / Spectacles",
  "conjunctiva/cornea/refractive surgery":"Conjunctiva / Cornea / Refractive Surgery",
  "lens/cataract/iol/pre & post-op care":"Lens / Cataract / IOL / Pre- & Post-Op Care",
  "lens / cataract / iol / pre and post op care":"Lens / Cataract / IOL / Pre- & Post-Op Care",
  "episclera/sclera/anterior uvea":"Episclera / Sclera / Anterior Uvea",
  "optic nerve/neuro ophthalmic pathways":"Optic Nerve / Neuro-Ophthalmic Pathways",
  "neuro-ophthalmic pathways":"Optic Nerve / Neuro-Ophthalmic Pathways",
  "systemic health / pathology / pharmacology":"Systemic Health",
  "ocular adnexa / orbit":"Lids / Lashes / Lacrimal / Adnexa / Orbit"
};

function normKey(s){
  return String(s||"")
    .toLowerCase()
    .replace(/\./g,"")
    .replace(/\s*\/\s*/g,"/")   // tighten slashes
    .replace(/\s*&\s*/g," & ")
    .replace(/\s+/g," ")
    .trim();
}
function canonize(label, canonMap, aliasMap){
  const k = normKey(label);
  for(const canon in canonMap){ if(normKey(canon)===k) return canonMap[canon]; }
  if(aliasMap[k]) return aliasMap[k];
  return String(label||"").trim();
}

/* ---------------- UTILS ---------------- */
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function pctClass(p){ return p>=90?'ok':(p>=75?'':'bad'); }

/* ---------------- DOM ---------------- */
const examDiv=document.getElementById('exam'),
      reportEl=document.getElementById('report'),
      dateEl=document.getElementById('dateStamp'),
      totalEl=document.getElementById('totalScore'),
      discBody=document.querySelector('#discSummary tbody'),
      condBody=document.querySelector('#condTable tbody'),
      subHost=document.getElementById('subcats');

let QUESTIONS=[], SHUFFLED=[];

/* ---------------- RENDER EXAM ---------------- */
function renderExam(){
  examDiv.innerHTML='';
  SHUFFLED.forEach((q,i)=>{
    const wrap=document.createElement('div'); wrap.className='question';
    const meta=`<div class="meta"><span class="pill">${q.discipline}</span><span class="pill">${q.condition}</span><span class="pill">${q.sub}</span></div>`;
    const choicesHtml=q.choices.map((c,idx)=>`<label class="choice"><input type="radio" name="q${i}" value="${idx}" />${c}</label>`).join('');
    wrap.innerHTML=`<div class="qhead"><h3>${i+1}. ${q.text}</h3>${meta}</div><div class="choices">${choicesHtml}</div><div id="rat${i}" class="rationale hide"></div>`;
    examDiv.appendChild(wrap);
  });
}

/* ---------------- SCORE ---------------- */
function scoreExam(){
  const perCond={}, perDisc={}, perSub={};
  CONDITIONS.forEach(c=>perCond[c]={correct:0,total:0});
  DISCIPLINES.forEach(d=>perDisc[d]={correct:0,total:0});
  CONDITIONS.forEach(c=>perSub[c]={});

  let correctTotal=0;
  SHUFFLED.forEach((q,i)=>{
    if(!perCond[q.condition]) perCond[q.condition]={correct:0,total:0};
    if(!perDisc[q.discipline]) perDisc[q.discipline]={correct:0,total:0};
    if(!perSub[q.condition]) perSub[q.condition]={};
    if(!perSub[q.condition][q.sub]) perSub[q.condition][q.sub]={correct:0,total:0};

    const picked=document.querySelector(`input[name='q${i}']:checked`);
    const chosenIdx=picked?parseInt(picked.value,10):-1;
    const ok=(chosenIdx===q.correctIndexAfterShuffle);
    if(ok) correctTotal++;

    perCond[q.condition].total++; if(ok) perCond[q.condition].correct++;
    perDisc[q.discipline].total++; if(ok) perDisc[q.discipline].correct++;
    perSub[q.condition][q.sub].total++; if(ok) perSub[q.condition][q.sub].correct++;

    const rat=document.getElementById('rat'+i);
    rat.classList.remove('hide');
    rat.innerHTML=(ok?'✅':'❌')+" <b>Correct:</b> "+q.choices[q.correctIndexAfterShuffle]+(q.rationale?("<br>"+q.rationale):"");
  });

  const pct=Math.round(100*correctTotal/SHUFFLED.length);
  return {perCond, perDisc, perSub, correctTotal, total:SHUFFLED.length, pct};
}

/* ---------------- REPORT ---------------- */
function pctCell(pct){ return `<td class="${pctClass(pct)}">${pct}%</td>`; }

function renderReport(res){
  reportEl.classList.remove('hide');
  dateEl.textContent=new Date().toLocaleString();
  totalEl.textContent=`${res.pct}% (${res.correctTotal} / ${res.total})`;
  document.getElementById('studentName').textContent=document.getElementById('s_name').value||'Anonymous';
  document.getElementById('schoolName').textContent=document.getElementById('s_school').value||'—';

  // Disciplines (no A/B/C/D/E shown)
  let rows=[], idx=1;
  DISCIPLINES.forEach(d=>{
    const r=res.perDisc[d]; if(!r||!r.total) return;
    const p=Math.round(100*r.correct/r.total);
    rows.push(`<tr><td>${idx++}</td><td>${d}</td>${pctCell(p)}<td>${r.correct} / ${r.total}</td></tr>`);
  });
  discBody.innerHTML=rows.join('');

  // Conditions
  rows=[]; idx=1;
  CONDITIONS.forEach(c=>{
    const r=res.perCond[c]; if(!r||!r.total) return;
    const p=Math.round(100*r.correct/r.total);
    rows.push(`<tr><td>${idx++}</td><td>${c}</td>${pctCell(p)}<td>${r.correct} / ${r.total}</td></tr>`);
  });
  condBody.innerHTML=rows.join('');

  // Subcategories
  let html='',cidx=1;
  CONDITIONS.forEach(c=>{
    const subs=res.perSub[c]; const keys=Object.keys(subs||{});
    if(!keys.length) return;
    html+=`<div class="summary" style="margin:10px 0 6px 0"><div class="brand">${cidx}. ${c}</div></div>`;
    html+='<table><thead><tr><th style="width:55%">Subcategory</th><th style="width:20%">% Correct</th><th>Correct / Total</th></tr></thead><tbody>';
    keys.sort().forEach(s=>{
      const r=subs[s]; const p=Math.round(100*r.correct/r.total);
      html+=`<tr><td>${s}</td>${pctCell(p)}<td>${r.correct} / ${r.total}</td></tr>`;
    });
    html+='</tbody></table>'; cidx++;
  });
  subHost.innerHTML=html||'<div class="muted">No subcategory data.</div>';

  document.getElementById('printBtn').disabled=false;
}

/* ---------------- RELIABLE PRINT (multi-use, Thinkific-safe) ---------------- */
function printReportInHiddenFrame(){
  const report=document.getElementById('report');
  if(!report||report.classList.contains('hide')){ alert('Please grade first.'); return; }

  const clone=report.cloneNode(true);
  clone.id='reportPrint';
  clone.classList.remove('hide');
  clone.querySelectorAll('.hide').forEach(el=>el.classList.remove('hide'));

  let styles=''; document.querySelectorAll('style').forEach(s=>styles+=s.innerHTML+'\n');
  const patch=`
    @media print { #reportPrint{display:block!important} .question, header, .actions, #studentBox{display:none!important} }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#111;margin:20px}
    @page{size:auto;margin:12mm}
  `;
  const html=`<!doctype html><html><head><meta charset="utf-8"><title>OD on the GO — Score Report</title><style>${styles}\n${patch}</style></head><body></body></html>`;

  let frame=document.getElementById('odgPrintFrame');
  if(!frame){
    frame=document.createElement('iframe');
    frame.id='odgPrintFrame';
    frame.style.position='fixed';
    frame.style.right='0';
    frame.style.bottom='0';
    frame.style.width='1px';
    frame.style.height='1px';
    frame.style.border='0';
    frame.setAttribute('aria-hidden','true');
    document.body.appendChild(frame);
  }

  const doc=frame.contentDocument||frame.contentWindow.document;
  doc.open(); doc.write(html); doc.close();

  const mount=()=>{
    try{
      doc.body.innerHTML='';
      doc.body.appendChild(clone);
      const w=frame.contentWindow;
      w.onafterprint=()=>{ try{ doc.body.innerHTML=''; }catch(_){} };
      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        w.focus(); w.print();
      }));
    }catch(_){
      setTimeout(mount,150);
    }
  };
  frame.onload=mount;
  setTimeout(mount,150);
}

/* ---------------- EVENTS ---------------- */
document.getElementById('gradeBtn').addEventListener('click', ()=>{
  const res=scoreExam();
  renderReport(res);
  window.scrollTo({top:reportEl.offsetTop-20,behavior:'smooth'});
});
document.getElementById('resetBtn').addEventListener('click', ()=>{
  prepareShuffled();
  renderExam();
  reportEl.classList.add('hide');
  document.getElementById('printBtn').disabled=true;
  window.scrollTo({top:0,behavior:'smooth'});
});
document.getElementById('printBtn').addEventListener('click', printReportInHiddenFrame);

/* ---------------- DATA LOAD & SHUFFLE ---------------- */
async function loadQuestions(){
  const r=await fetch(QUESTIONS_URL,{cache:'no-store'});
  if(!r.ok) throw new Error('Failed to load questions.json');
  const bank=await r.json();
  bank.forEach((q,i)=>{
    if(typeof q.id!=='number') q.id=i+1;
    if(!Array.isArray(q.choices)) q.choices=[];
    if(typeof q.correct!=='number') q.correct=0;
    if(typeof q.text!=='string') q.text='';
    if(typeof q.rationale!=='string') q.rationale='';

    // normalize labels to canonical (disciplines without A/B/C/D/E)
    q.discipline = canonize(q.discipline, CANON_DISC, DISC_ALIASES);
    q.condition  = canonize(q.condition,  CANON_COND, COND_ALIASES);
    q.sub        = (typeof q.sub==='string') ? q.sub.trim() : '';
  });

  // optional console tallies for quick verification during build
  try{
    const dTally={}, cTally={};
    bank.forEach(q=>{
      dTally[q.discipline] = (dTally[q.discipline]||0)+1;
      cTally[q.condition]  = (cTally[q.condition]||0)+1;
    });
    console.table(dTally);
    console.table(cTally);
  }catch(_){}

  QUESTIONS=bank;
}
function prepareShuffled(){
  const qs=QUESTIONS.map(q=>JSON.parse(JSON.stringify(q)));
  shuffle(qs);
  qs.forEach(q=>{
    const orig=q.choices.map((c,i)=>({text:c,originalIdx:i}));
    shuffle(orig);
    q.choices=orig.map(o=>o.text);
    const newIdx=orig.findIndex(o=>o.originalIdx===q.correct);
    q.correctIndexAfterShuffle=newIdx>=0?newIdx:0;
  });
  SHUFFLED=qs;
}

/* ---------------- BOOT ---------------- */
(async function boot(){
  try{
    await loadQuestions();
    prepareShuffled();
    renderExam();
  }catch(e){
    console.error(e);
    examDiv.innerHTML=`<div class="summary"><b>Error:</b> ${e.message}</div>`;
  }
})();
</script>
</body>
</html>
