<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OD on the GO — Diagnostic (NBEO-Weighted, Categorized)</title>
<style>
  :root{ --bg:#fff; --fg:#111; --muted:#667085; --brand:#0b6bcb; --ok:#0a7f2e; --bad:#b00020; --card:#f8fafc; --border:#e6e8eb; }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;z-index:10}
  header .wrap{max-width:1100px;margin:0 auto;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{font-size:20px;margin:0}
  .pill{border:1px solid var(--border);border-radius:999px;padding:2px 8px;background:var(--card);font-size:12px;color:var(--muted)}
  main{max-width:1100px;margin:18px auto;padding:0 16px 40px}
  .question{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0}
  .qhead{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .choices{display:grid;gap:8px;margin-top:8px}
  label.choice{display:flex;gap:8px;align-items:flex-start;padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
  .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
  .summary{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:14px 0}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin:18px 0}
  button{border:1px solid var(--border);background:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
  button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
  th{background:#f6f8fb}
  table{width:100%;border-collapse:collapse;margin-bottom:8px}
  .ok{color:var(--ok);font-weight:600}
  .bad{color:var(--bad);font-weight:600}
  .muted{color:var(--muted)}
  .hide{display:none}
  .brand{font-weight:700}
  .rationale{margin-top:8px;font-size:13px;border-left:3px solid var(--border);padding-left:10px}
  input[type="text"],select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}

  /* Print/PDF = score report ONLY (hide questions, rationales, header, actions, meta, student box) */
  @media print{
    header,.actions,.rationale,.meta,#studentBox,.question{display:none!important}
    body{background:#fff}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>OD on the GO — Diagnostic</h1>
    <span class="pill">NBEO-weighted • Discipline → Condition → Subcategory</span>
    <div style="flex:1"></div>
    <small class="muted">Student-facing</small>
  </div>
</header>

<main>
  <!-- Student metadata (school required) -->
  <div id="studentBox" class="summary">
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;">
      <label>Student name
        <input id="s_name" type="text" placeholder="First Last">
      </label>
      <label>School (required)
        <select id="s_school" required>
          <option value="" selected>Select your school…</option>
          <option value="Alabama — UAB School of Optometry">Alabama — UAB School of Optometry</option>
          <option value="Arizona — Midwestern University AZCOPT">Arizona — Midwestern University AZCOPT</option>
          <option value="California — SCCO at Marshall B. Ketchum University">California — SCCO at Marshall B. Ketchum University</option>
          <option value="California — UC Berkeley School of Optometry">California — UC Berkeley School of Optometry</option>
          <option value="California — WesternU College of Optometry">California — WesternU College of Optometry</option>
          <option value="Canada — University of Waterloo (School of Optometry & Vision Science)">Canada — University of Waterloo (School of Optometry & Vision Science)</option>
          <option value="Canada — Université de Montréal (École d’optométrie)">Canada — Université de Montréal (École d’optométrie)</option>
          <option value="Florida — Nova Southeastern University (NSU)">Florida — Nova Southeastern University (NSU)</option>
          <option value="Illinois — Illinois College of Optometry (ICO)">Illinois — Illinois College of Optometry (ICO)</option>
          <option value="Indiana — IU School of Optometry">Indiana — IU School of Optometry</option>
          <option value="Kentucky — KYCO (University of Pikeville)">Kentucky — KYCO (University of Pikeville)</option>
          <option value="Massachusetts — New England College of Optometry (NECO)">Massachusetts — New England College of Optometry (NECO)</option>
          <option value="Michigan — Michigan College of Optometry (Ferris State)">Michigan — Michigan College of Optometry (Ferris State)</option>
          <option value="Missouri — UMSL College of Optometry">Missouri — UMSL College of Optometry</option>
          <option value="New York — SUNY College of Optometry">New York — SUNY College of Optometry</option>
          <option value="North Carolina — High Point University School of Optometry">North Carolina — High Point University School of Optometry</option>
          <option value="Ohio — The Ohio State University College of Optometry">Ohio — The Ohio State University College of Optometry</option>
          <option value="Oklahoma — NSU Oklahoma College of Optometry (NSUOCO)">Oklahoma — NSUOCO</option>
          <option value="Oregon — Pacific University College of Optometry">Oregon — Pacific University College of Optometry</option>
          <option value="Pennsylvania — Salus University (PCO)">Pennsylvania — Salus University (PCO)</option>
          <option value="Puerto Rico — Inter American University School of Optometry (IAUPR)">Puerto Rico — IAUPR</option>
          <option value="Texas — UIW Rosenberg School of Optometry (UIWRSO)">Texas — UIWRSO</option>
          <option value="Texas — University of Houston College of Optometry (UHCO)">Texas — UHCO</option>
          <option value="Texas — University of Texas Rio Grande Valley School of Optometry (UTRGV)">Texas — UTRGV</option>
          <option value="Utah — Rocky Mountain University College of Optometry">Utah — Rocky Mountain University</option>
        </select>
      </label>
    </div>
    <small class="muted">You must select a school before grading.</small>
  </div>

  <div class="summary">
    <div><span class="brand">Instructions:</span> One answer per question. Click <b>Grade Exam</b> to see and print your score report.</div>
  </div>

  <div id="exam"></div>

  <div class="actions">
    <button id="gradeBtn" class="primary" disabled>Grade Exam</button>
    <button id="resetBtn">Reset</button>
    <button id="printBtn" disabled>Print / Save PDF</button>
  </div>

  <section id="report" class="hide">
    <div class="summary">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
        <div><b>Student:</b> <span id="studentName">Anonymous</span></div>
        <div><b>School:</b> <span id="schoolName">—</span></div>
        <div><b>Date:</b> <span id="dateStamp"></span></div>
        <div><b>Total Score:</b> <span id="totalScore" class="brand"></span></div>
        <div><b>Status:</b> <span id="submitStatus" class="muted">Not sent</span></div>
      </div>
    </div>

    <h3>Discipline-Level Summary</h3>
    <table id="discSummary"><thead><tr><th>#</th><th>Discipline</th><th>% Correct</th><th>Correct / Total</th></tr></thead><tbody></tbody></table>

    <h3>Condition Breakdown</h3>
    <table id="condTable"><thead><tr><th>#</th><th>Condition Area</th><th>% Correct</th><th>Correct / Total</th></tr></thead><tbody></tbody></table>

    <h3>Subcategory Breakdown</h3>
    <div id="subcats"></div>

    <div class="summary">
      <div><b>Legend:</b> <span class="ok">≥90% strong</span> · 75–89% steady · <span class="bad">≤74% needs review</span></div>
    </div>
  </section>
</main>

<script>
/* =========================
   HELPERS
========================= */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function formatPct(correct,total){
  if(!total) return 0;
  return Math.round(100*correct/total);
}

/* =========================
   TAXONOMY
========================= */
const DISCIPLINES = [
  "A. Anatomy",
  "B. Biochemistry / Physiology",
  "C. Immunology / Microbiology / Pathology",
  "D. Optics",
  "E. Pharmacology"
];

const CONDITIONS = [
  "Ametropia","Ophthalmic Optics / Spectacles","Contact Lenses","Low Vision",
  "Accommodation / Vergence / Oculomotor","Amblyopia / Strabismus","Perceptual Function / Color Vision","Visual & Human Development",
  "Lids / Lashes / Lacrimal / Adnexa / Orbit","Conjunctiva / Cornea / Refractive Surgery","Lens / Cataract / IOL / Pre- & Post-Op Care",
  "Episclera / Sclera / Anterior Uvea","Vitreous / Retina / Choroid","Optic Nerve / Neuro-Ophthalmic Pathways","Glaucoma","Emergencies / Trauma","Systemic Health"
];

/* =========================
   QUESTION BANK MODEL
   Each question:
   {
     id: 196,                       // integer id (optional but recommended)
     text: "Stem text...",
     choices: ["A","B","C","D"],    // strings
     correct: 0,                    // index in choices (0-based)
     discipline: "D. Optics",
     condition: "Ametropia",
     sub: "Vergence & Far Point",
     rationale: "Brief rationale..."
   }
========================= */

/* ---- STARTER SAMPLE (~20 Qs) ----
   Add your remaining items below in the exact same format.
   (No asterisks; the correct answer is by index via `correct`.)
*/
const QUESTIONS = [
  // Geometric/clinical optics sample
  {id:196, text:"Patient’s far point is -50 cm from principal plane. What’s the refractive state?",
   choices:["Myopia of 2.00 D","Hyperopia of 2.00 D","Emmetropia","Mixed astigmatism"],
   correct:0, discipline:"D. Optics", condition:"Ametropia", sub:"Vergence & Far Point",
   rationale:"Vergence at far point = -1/0.50 m = -2.00 D → myopia."
  },
  {id:197, text:"Which change reduces spectacle magnification for same vertex power?",
   choices:["Flatter front curve (lower base)","Steeper front curve","Increase center thickness","Lower index"],
   correct:0, discipline:"D. Optics", condition:"Ophthalmic Optics / Spectacles", sub:"Spectacle Magnification",
   rationale:"Flatter base curve and thinner lens reduce SM."
  },
  {id:198, text:"High-water ionic hydrogels are most prone to which deposit?",
   choices:["Protein","Lipid","Mucin","Calcium"],
   correct:0, discipline:"A. Anatomy", condition:"Contact Lenses", sub:"Materials & Deposits",
   rationale:"Ionic high-water hydrogels attract tear proteins."
  },
  {id:199, text:"AC/A is best estimated clinically by which method?",
   choices:["Gradient method","Crossed cylinder test","Worth 4-dot","Stereoacuity at near"],
   correct:0, discipline:"A. Anatomy", condition:"Accommodation / Vergence / Oculomotor", sub:"AC/A Ratio",
   rationale:"Gradient AC/A measures change in near phoria with added lenses."
  },
  {id:200, text:"Large constant ET with DVD and latent nystagmus suggests:",
   choices:["Infantile esotropia","Accommodative ET","Intermittent XT","Decompensated phoria"],
   correct:0, discipline:"A. Anatomy", condition:"Amblyopia / Strabismus", sub:"Infantile ET",
   rationale:"Classic triad: constant ET, DVD, latent nystagmus."
  },
  {id:201, text:"Which test screens congenital red–green defects?",
   choices:["Ishihara","D-15 desaturated","Anomaloscope luminance match","HRR tritan-only pages"],
   correct:0, discipline:"A. Anatomy", condition:"Perceptual Function / Color Vision", sub:"Screening Tests",
   rationale:"Ishihara is a standard screening for red–green anomalies."
  },
  {id:202, text:"Painful photophobic eye with ciliary flush and miotic pupil:",
   choices:["Anterior uveitis","Bacterial conjunctivitis","Episcleritis","Acute angle closure"],
   correct:0, discipline:"C. Immunology / Microbiology / Pathology", condition:"Episclera / Sclera / Anterior Uvea", sub:"Anterior Uveitis",
   rationale:"Findings fit anterior uveitis."
  },
  {id:203, text:"Altitudinal field loss with a ‘disc-at-risk’ is typical for:",
   choices:["NAION","LHON","Toxic neuropathy","Chiasmal compression"],
   correct:0, discipline:"C. Immunology / Microbiology / Pathology", condition:"Optic Nerve / Neuro-Ophthalmic Pathways", sub:"Ischemic Optic Neuropathy",
   rationale:"NAION: altitudinal defect + small crowded disc."
  },
  {id:204, text:"Which presentation fits acute primary angle closure?",
   choices:["Mid-dilated pupil, corneal edema, severe pain","Open angle with cupping","Sectoral redness only","Clear cornea with dendrites"],
   correct:0, discipline:"E. Pharmacology", condition:"Glaucoma", sub:"Angle-Closure",
   rationale:"Classic AAC findings include mid-dilated pupil and corneal edema with pain."
  },
  {id:205, text:"In DKA the primary disturbance is:",
   choices:["Metabolic acidosis","Respiratory acidosis","Metabolic alkalosis","Respiratory alkalosis"],
   correct:0, discipline:"B. Biochemistry / Physiology", condition:"Systemic Health", sub:"Endocrine—Diabetes",
   rationale:"DKA = metabolic acidosis; respiratory compensation via Kussmaul breathing."
  },

  // Add a few Physical Optics / Photometry samples
  {id:206, text:"When light passes from lower to higher index at oblique incidence, which is TRUE?",
   choices:["Angle of refraction < angle of incidence","Angle of refraction > angle of incidence","No refraction occurs","Critical angle is exceeded"],
   correct:0, discipline:"D. Optics", condition:"Ophthalmic Optics / Spectacles", sub:"Snell’s Law",
   rationale:"n2>n1 → ray bends toward normal → smaller refracted angle."
  },
  {id:207, text:"A polarizer transmits which component of light?",
   choices:["Electric field component parallel to its axis","Component perpendicular to its axis","All components equally","Only circular polarization"],
   correct:0, discipline:"D. Optics", condition:"Perceptual Function / Color Vision", sub:"Polarization Basics",
   rationale:"Ideal linear polarizer passes the component parallel to its transmission axis."
  },
  {id:208, text:"A neutral density (ND) filter of OD = 1.0 transmits ~",
   choices:["10%","1%","37%","50%"],
   correct:0, discipline:"D. Optics", condition:"Perceptual Function / Color Vision", sub:"Photometry/ND",
   rationale:"Optical density OD=1 → 10^(-1) = 10% transmittance."
  },
  {id:209, text:"Which increases diffraction effects for a circular aperture?",
   choices:["Smaller pupil diameter","Larger pupil diameter","Higher luminance","Shorter wavelength blocked"],
   correct:0, discipline:"D. Optics", condition:"Perceptual Function / Color Vision", sub:"Diffraction/Airy",
   rationale:"Smaller aperture increases diffraction spread (Airy disk diameter ∝ λ / D)."
  },

  // A couple more general items
  {id:210, text:"Which drop is most likely to darken the iris color over time?",
   choices:["Latanoprost","Timolol","Brimonidine","Acetazolamide"],
   correct:0, discipline:"E. Pharmacology", condition:"Glaucoma", sub:"Prostaglandin AEs",
   rationale:"PG analogs can increase
